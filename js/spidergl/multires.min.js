/*************************************************************************/
/*                                                                       */
/*  WebMultiRes                                                          */
/*  JavaScript 3D Graphics Library on top of SpiderGL for web            */
/*  visualization of high resolution RTI images                          */
/*                                                                       */
/*  Copyright (C) 2013-2016                                              */
/*  Gianpaolo Palma                                                      */
/*  Visual Computing Laboratory                                          */
/*  ISTI - Italian National Research Council (CNR)                       */
/*  http://vcg.isti.cnr.it/rti/webviewer.php                             */
/*  mailto: gianpaolo[DOT]palma[AT]isti[DOT]cnr[DOT]it                   */
/*                                                                       */
/*                                                                       */
/*  This program is free software: you can redistribute it and/or modify */
/*  it under the terms of the GNU General Public License as published by */
/*  the Free Software Foundation, either version 3 of the License, or    */
/*  (at your option) any later version.                                  */
/*                                                                       */
/*  This program is distributed in the hope that it will be useful,      */
/*  but WITHOUT ANY WARRANTY; without even the implied warranty of       */
/*  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the        */
/*  GNU General Public License for more details.                         */
/*                                                                       */ 
/*  You should have received a copy of the GNU General Public License    */
/*  along with this program.  If not, see <http://www.gnu.org/licenses/> */
/*************************************************************************/

function createRtiViewer(t,e,i,s){function r(){l=!1,$("#"+t+"_div button").removeClass("ui-state-hover ui-state-active ui-state-focus")}function n(){var e=document.getElementById(t+"_div");e.requestFullscreen?e.requestFullscreen():e.webkitRequestFullscreen?e.webkitRequestFullscreen():e.mozRequestFullScreen?e.mozRequestFullScreen():e.msRequestFullscreen&&e.msRequestFullscreen(),e.style.height=screen.height+"px",e.style.width=screen.width+"px";var i=$("#"+t+"_webgl");i.height(screen.height),i.width(screen.width),i.attr("width",screen.width),i.attr("height",screen.height),multiResRTI.resize(),u=!0;var s=60,n=(screen.height-120)/5;s>n&&(s=n),$("#"+t+"_div button").css("height",s),$("#"+t+"_div button").css("width",s);var o={label:"Exit Fullscreen",icons:{primary:"fullOnIcon toolbarIcon"}};$("#"+t+"_div #fullscreen").button("option",o),setTimeout(function(){r(4)},300)}function o(){var e=document.getElementById(t+"_div");document.exitFullscreen?document.exitFullscreen():document.webkitExitFullscreen?document.webkitExitFullscreen():document.mozCancelFullScreen?document.mozCancelFullScreen():document.msExitFullscreen&&document.msExitFullscreen(),e.style.height=h+"px",e.style.width=d+"px";var i=$("#"+t+"_webgl");i.height(h),i.width(d),i.attr("width",d),i.attr("height",h),multiResRTI.resize(),u=!1;var s=60*h/screen.height,n=(h-120)/5;s>n&&(s=n),$("#"+t+"_div button").css("height",s),$("#"+t+"_div button").css("width",s);var o={label:"Active Fullscreen",icons:{primary:"fullIcon toolbarIcon"}};$("#"+t+"_div #fullscreen").button("option",o),setTimeout(function(){r(4)},300)}function a(e){"IMAGE"==e&&$("#"+t+"_div #light").css("display","none"),$(".toolbar").css("visibility","visible"),f.contentEditable=!1,f.setAttribute("tabindex","0"),f.focus()}var l=!1,h=s,d=i,u=!1,c=$($("#"+t)[0]),m=document.createElement("div");m.id=t+"_div",m.style.height=s+"px",m.style.width=i+"px",m.style.margin="auto",m.style.position="relative",c.append(m);var g=$($("#"+t+"_div")[0]),p=t+"_webgl",f=document.createElement("canvas");f.id=p,f.width=i,f.height=s,g.append(f);var v=document.createElement("a");v.href="http://vcg.isti.cnr.it/rti/webviewer.php",v.target="_blank";var _=document.createElement("div");_.style.width="80px",_.style.height="50px",v.appendChild(_),v.style.position="absolute",v.style.bottom="0px",v.style.left="0px",v.style.cssFloat="left",g.append(v);var b=60*h/screen.height,x=(h-120)/5;b>x&&(b=x);var M=document.createElement("div");M.setAttribute("class","toolbar"),M.style.position="absolute",M.style.top="0px",M.style.left="0px",M.style.margin="10px 0px 0px 10px",M.style.cssFloat="left",M.style.width=b+"px",M.style.height="400px",M.style.visibility="hidden",M.innerHTML='<button class = "toolbarButton" id = "zoomIn" touch-action="none"></button><button class = "toolbarButton" id = "zoomOut" touch-action="none"></button><button class = "toolbarButton" id = "light" touch-action="none"></button><button class = "toolbarButton" id = "fullscreen" touch-action="none"></button><button class = "toolbarButton" id = "help" touch-action="none"></button>',g.append(M),$("#"+t+"_div button").css("height",b),$("#"+t+"_div button").css("width",b);var w=document.createElement("div");w.id=t+"_guide",w.style.width="100%",w.style.height="100%",w.style.position="absolute",w.style.left="0px",w.style.top="0px",w.style.color="#FFFFFF",w.style.backgroundColor="rgba(0, 0, 0, 0.9)",w.innerHTML='<div id = "guideTable"><div id = "guideCell"> <div id = "guideList"><h3>WebRTIViewer<br/></h3><ul><li>Pan: LeftMouseButton + MouseMove.</li><li>Zoom in: MouseWhell or press the button <span><img src = "css/icons/zoomin.png" alt=""/></span></li><li>Zoom out: MouseWheel or press the button <span><img src = "css/icons/zoomout.png" alt=""/></span></li><li>To change the light direction: activate the light with the button <span><img src = "css/icons/light.png" alt=""/></span> and press LeftMouseButton + MouseMove or Ctrl + LeftMouseButton + MouseMove.</li><li>Fullscreen: press the button <span><img src = "css/icons/full.png" alt=""/></span> to active the fullscreen mode and the button <span><img src = "css/icons/full_on.png" alt=""/></span> to exit</li><li>To reset the viewpoint: press R.</li></ul><a href="http://vcg.isti.cnr.it/rti/webviewer.php" target = "_black">Visual Computing Lab ISTI CNR Pisa</a></div></div></div>',w.style.display="none",g.append(w),$("#"+t+"_div #zoomIn").button({icons:{primary:"zoomInIcon toolbarIcon"},text:!1,label:"Zoom In"}).on("pointerdown",function(t){multiResRTI.setRepeat(0),l="touch"==t.originalEvent.pointerType?!0:!1}).on("pointerup",function(t){multiResRTI.clearRepeat(t),r(0)}).on("pointerleave",function(t){multiResRTI.clearRepeat(t),r(0)}).click(function(){r(0)}),$("#"+t+"_div #zoomOut").button({icons:{primary:"zoomOutIcon toolbarIcon"},text:!1,label:"Zoom Out"}).on("pointerdown",function(t){multiResRTI.setRepeat(1),l="touch"==t.originalEvent.pointerType?!0:!1}).on("pointerup",function(t){multiResRTI.clearRepeat(t),r(1)}).on("pointerleave",function(t){multiResRTI.clearRepeat(t),r(1)}).click(function(){r(1)}),$("#"+t+"_div #light").button({icons:{primary:"lightIcon toolbarIcon"},text:!1,label:"Light Off"}).on("pointerdown",function(t){l="touch"==t.originalEvent.pointerType?!0:!1;var e;"Light Off"==$(this).text()?(e={label:"Light On",icons:{primary:"lightOnIcon toolbarIcon"}},multiResRTI.setMode(1)):(e={label:"Light Off",icons:{primary:"lightIcon toolbarIcon"}},multiResRTI.setMode(0)),$(this).button("option",e)}).on("pointerup",function(){r(2)}).on("pointerleave",function(){r(2)}).click(function(){r(2)}),$("#"+t+"_div #help").button({icons:{primary:"helpIcon toolbarIcon"},text:!1,label:"Help"}).on("pointerdown",function(e){l||(l="touch"==e.originalEvent.pointerType?!0:!1,$("#"+t+"_div a").unbind("click"),$("#"+t+"_div a").click(function(){return!1}),$("#"+t+"_guide").show(),setTimeout(function(){$("#"+t+"_div a").unbind("click"),$("#"+t+"_div a").click(function(t){t.stopPropagation()}),r(4)},300))}),$("#"+t+"_div #fullscreen").button({icons:{primary:"fullIcon toolbarIcon"},text:!1,label:"Active Fullscreen"}).on("pointerdown",function(e){if(!l){l="touch"==e.originalEvent.pointerType?!0:!1;u?o():n(),$("#"+t+"_div #fullscreen").removeClass("ui-state-hover")}}),document.addEventListener("MSFullscreenChange",function(){document.msFullscreenElement||o()},!1),document.addEventListener("mozfullscreenchange",function(){document.mozFullScreen||o()},!1),document.addEventListener("webkitfullscreenchange",function(){document.webkitIsFullScreen||o()},!1),$("#"+t+"_guide").on("click",function(){l||($("#"+t+"_guide").hide(),r(4))});var y=document.createElement("div");y.id=t+"_error",y.style.width="100%",y.style.height="100%",y.style.position="absolute",y.style.left="0px",y.style.top="0px",y.style.color="#FFFFFF",y.style.backgroundColor="rgba(0, 0, 0, 1.0)",y.innerHTML='<canvas id = "testCanvas" width= "800" height= "600" contenteditable="true"></canvas>',y.style.display="none",g.append(y),null==sglGetCanvasContext("testCanvas")?(y.style.display="block",y.innerHTML='<div id = "contentError" style = "width: 90%; height: 100%; text-align:left; padding:0% 5% 0% 5%; font-family:  Verdana,sans-serif; overflow-y: scroll;"><h3>WebGL is not available or not enabled.</h3><p><a href="http://en.wikipedia.org/wiki/WebGL">WebGL</a> is the technology we use to display the RTI images. It is currently supported, but sometimes not enabled by default, by recent versions of <a href="http://www.mozilla.org/firefox">Firefox</a>, <a href="http://www.google.com/chrome">Chrome</a> and <a href="http://www.apple.com/safari">Safari</a>. An external plugins is available for <a href="http://microsoft.com/ie">Internet  Explorer</a>.<br/> It also requires a moderately recent and capable hardware and up to date drivers.</p><p><b>Chrome</b><br/>Type "chrome://flags" in the address bar.<br/>Disable (yes, it is a confusing double negation!) the WebGL entry.<br/>Click the <em>relaunch now</em> button at the bottom.</p><p><b>Firefox</b><br/>Type "about:config" in the address bar<br/>Type "webgl" in the <em>Filter</em>.<br/>Doubleclick the entry <b>webgl.force-enable</b>, and restart Firefox.</p><p><b>Safari</b><br/>Open the Safari menu and select Preferences.<br/>Then, click the Advanced tab in the Preferences window.<br/>Then, at the bottom of the window, check the Show Develop menu in menu bar checkbox.<br/>Then, open the Develop menu in the menu bar and select Enable WebGL.</p><p><b>Internet Explorer (from version 9.0)</b><br/>Install the <a href="http://www.google.com/chromeframe">Chrome Frame</a> <br/>Open the Tools menu and select Manage add-ons.<br/>Then, enable the ChromeFrame BHO plugins and restart Internet Explorer.<br/></p><p><b>Installing updated drivers</b><br/>If the visualization of the RTI image fails you must update the drivers of your graphics cards.</p></div>'):(y.innerHTML="",multiResRTI=new MultiRes(p),multiResRTI.setImageUrl(e),multiResRTI.setOnLoadImageCallback(a),sglRegisterCanvas(p,multiResRTI,10))}function log(){}function MultiRes(t){this.mode=0,this.stepAnimation=0,this.idTimer,this.canvas=t,this.rendering=!1,this.onDrawCallback=null,this.animating=!1,this.moveToCenter=!1,this.imageUrl="",this.OnLoadImageCallback=null,this.currentSpeed=0,this.maxStep=3,this.animationStack=[],this.isMoving=!1,this.isRepeating=!1,this.btnType=-1}function MultiResNode(){this.id=0,this.parentIndex=-1,this.childrenIndices=[-1,-1,-1,-1],this.projectedSize=1,this.zScale=1,this.box=new SglBox3,this.priority={timestamp:-1,error:Number.MAX_VALUE},this.req=null,this.data=null,this.isLeaf=!0}function MultiResTree(t,e){this.ready=!0,this.nodesCount=0,this.rootIndex=-1,this.nodes=null,this.url=null,this.tileSize=0,this.scale=[1,1,1],this.offset=[0,0,0],this.forma="",t&&this.load(t,imgW,imgH,e)}function _MultiResAssert(t){t||alert("MultiResAssert FAILED : "+t)}function _MultiResCompareNodes(t,e){return t.priority.timestamp!=e.priority.timestamp?e.priority.timestamp-t.priority.timestamp:t.priority.error!=e.priority.error?e.priority.error-t.priority.error:t.id-e.id}function MultiResRenderer(t,e){this.lg=!0,this.gl=t,this._tree=new MultiResTree,this._timestamp=0,this._frustum=new SglFrustum,this._maxError=1,this._cache=[],this._cacheSizeInBytes=e,this._maxCacheSize=1,this._maxOngoingRequests=2,this._currentOngoingRequests=0,this._toRequest=[],this._toRenderFullRes=[],this._toRenderHalfRes=[],this._readyItems=[],this.renderData=!0,this.renderBoxes=!1;var i=new Float32Array([-.5,-.5,.5,.5,-.5,.5,-.5,.5,.5,.5,.5,.5,-.5,-.5,-.5,.5,-.5,-.5,-.5,.5,-.5,.5,.5,-.5]),s=new Uint16Array([0,1,2,2,1,3,5,4,7,7,4,6,4,0,6,6,0,2,1,5,3,3,5,7,2,3,6,6,3,7,4,5,0,0,5,1]),r=new Uint16Array([0,1,1,3,3,2,2,0,5,4,4,6,6,7,7,5,0,4,1,5,3,7,2,6]),n=new SglMeshGL(t);n.addVertexAttribute("position",3,i),n.addIndexedPrimitives("triangles",t.TRIANGLES,s),n.addIndexedPrimitives("edges",t.LINES,r),this._boxMesh=n,this._tileFullMesh=null,this._tileHalfMesh=null,this._program=null;var o=sglLoadFile("spidergl/box.v.glsl"),a=sglLoadFile("spidergl/box.f.glsl"),l=new SglProgram(t,[o],[a]);log(l.log),this._boxProgram=l,this._boxRenderer=new SglMeshGLRenderer(this._boxProgram),this._treeTransform=sglIdentityM4(),this._normalizedTreeTransform=sglIdentityM4(),this.updateData=!0;var h="#ifdef GL_ES\nprecision highp float;\n#endif\nuniform   mat4 u_mvp;\nattribute vec2 a_position;\nattribute vec2 a_texcoord;\nvarying   vec2 v_texcoord;\nvoid main(void){\nv_texcoord  = a_texcoord;\ngl_Position = u_mvp * vec4(a_position, 0.0, 1.0);\n}",d="#ifdef GL_ES\nprecision highp float;\n#endif\nuniform sampler2D s_texture;\nvarying vec2     v_texcoord;\nvoid main(void){vec4 color = texture2D(s_texture, v_texcoord).xyzw;\nif (color.w > 0.7)\ngl_FragData[0] = vec4(color.rgb, 1.0);\nelse\ngl_FragData[0] = vec4(0.0);}";this.texProg=new SglProgram(this.gl,[h],[d]),log(this.texProg.log);var u=new Float32Array([0,0,80,0,0,50,80,50]),c=new Float32Array([0,0,1,0,0,1,1,1]);if(this.lg){var m=new SglMeshGL(this.gl);m.addVertexAttribute("position",2,u),m.addVertexAttribute("texcoord",2,c),m.addArrayPrimitives("tristrip",this.gl.TRIANGLE_STRIP,0,4),this.lgMesh=m,this.lgtex=null,this._createLg()}this.enumType=new Object,this.enumType.HSH_RTI=1,this.enumType.LRGB_PTM=2,this.enumType.RGB_PTM=3,this.enumType.IMAGE=4}var multiResRTI,openLink=!1;MultiRes.prototype={setMode:function(t){this.mode=t},_setLightDir:function(t,e){var i=t/this.ui.width*2.2-1.1,s=e/this.ui.height*2.2-1.1;i=Math.min(1,Math.max(-1,i)),s=Math.min(1,Math.max(-1,s));var r=Math.sqrt(i*i+s*s);r>1&&(r=1);var n=Math.PI/2;0!=i&&(n=Math.atan2(s,i)),i=r*Math.cos(n),s=r*Math.sin(n);var o=[];o=1>r?[i,s,Math.sqrt(1-i*i-s*s)]:[i,s,0],o=sglNormalizedV3(o),this.renderer.lightPos=o.slice(0,3),this.renderer.lweights=this.renderer.computeLightingFunction(o)},resetViewpoint:function(){this.translation[0]=0,this.translation[1]=0,this.mat=sglIdentityM4(),this.flipMatrix=sglIdentityM4()},setImageUrl:function(t){this.imageUrl=t},setOnLoadImageCallback:function(t){this.OnLoadImageCallback=t},load:function(t){log("SpiderGL Version : "+SGL_VERSION_STRING+"\n"),this.xform=new SglTransformStack,this.renderer=new MultiResRenderer(t,268435456),this.translation=[0,0],this.mat=sglIdentityM4(),this.flipMatrix=sglIdentityM4(),""!=this.imageUrl&&this.loadImage(this.imageUrl)},loadImage:function(t){this.renderer.loadImage(t),this.OnLoadImageCallback(this.renderer.type),this.xform=new SglTransformStack,this.translation=[0,0],this.mat=sglIdentityM4(),this.rendering=!0,this.leftBottom=[(this.renderer._tree.scale[0]-this.renderer.imgWidth)/2,(this.renderer._tree.scale[1]-this.renderer.imgHeight)/2],this.rightTop=[this.leftBottom[0]+this.renderer.imgWidth,this.leftBottom[1]+this.renderer.imgHeight],this.scale=0;var e=this.ui.width,i=this.ui.height,s=this.renderer._tree.scale[0]/this.renderer.imgWidth*e,r=this.renderer._tree.scale[1]/this.renderer.imgHeight*i;this.scale=Math.min(s,r),this.maxScale=2.5*Math.max(this.renderer.imgWidth/e,this.renderer.imgHeight/i),this.viewerdx=100,this.viewerdy=100},stopRendering:function(){this.rendering=!1},setOnDrawCallback:function(t){t&&(this.onDrawCallback=t)},clearRepeat:function(){this.isRepeating&&(this.isRepeating=!1,this.btnType=-1,this.endAnimation=!0)},setRepeat:function(t){this.isRepeating=!0,this.btnType=t,this.repeatEvent(t)},repeatEvent:function(t){switch(t){case 0:this.startZoomIn();break;case 1:this.startZoomOut()}},keyDown:function(t,e,i){"R"==i&&this.resetViewpoint(),"1"==i&&(this.renderer.renderData=!this.renderer.renderData),"2"==i&&(this.renderer.renderBoxes=!this.renderer.renderBoxes)},mouseWheel:function(t,e,i,s){if(this.isMoving)return!1;var r=i-this.translation[0],n=s-this.translation[1],o=sglPow(.98,10*e);this._startZoom(o,r,n)},startZoomIn:function(){if(this.isMoving)return!1;var t=this.ui.width/2-this.translation[0],e=this.ui.height/2-this.translation[1],i=1.1;this._startZoom(i,t,e)},startZoomOut:function(){if(this.isMoving)return!1;var t=this.ui.width/2-this.translation[0],e=this.ui.height/2-this.translation[1],i=.9;this._startZoom(i,t,e)},_startZoom:function(t,e,i){var s=this.mat[0]*t;s>this.maxScale&&(t=this.maxScale/this.mat[0]),1>s&&(t=1/this.mat[0]),1.0000001>=s&&(this.moveToCenter=!0);var r=t*this.mat[0]-this.mat[0];if(r>1e-4||-1e-4>r){this.animationStack=[];for(var n=2*this.maxStep,o=3*r/(n*n*n),a=-2*n*o,l=o*n*n,h=this.mat[0],d=0;n>d;d++){var u=o*d+o/3+a/2+l;l+=o*(2*d+1)+a;var c=1+u/h;h+=u,this.animationStack.push([c,e,i])}this.animating=this.moveToCenter;var m=this;clearInterval(this.moveInterval),clearInterval(this.zoomInterval),this.zoomInterval=setInterval(function(){m._zoomAnimation()},35),this.renderer.updateData=!1,this.isMoving=this.moveToCenter}else if(this.moveToCenter){this.animating=!0,this.isMoving=!0;var m=this;this.animationStack=[],clearInterval(this.moveInterval),clearInterval(this.zoomInterval),this.zoomInterval=setInterval(function(){m._zoomAnimation()},35),this.renderer.updateData=!1}return!1},_zoomAnimation:function(){if(0==this.animationStack.length){if(clearInterval(this.zoomInterval),this.moveToCenter){var t=this;clearInterval(this.moveInterval),this.moveInterval=setInterval(function(){t._moveAnimation()},35),this.renderer.updateData=!1,this.isMoving=!0,this.computeModelMatrix();var e=this.xform.model.top,i=[this.renderer._tree.scale[0]/2,this.renderer._tree.scale[1]/2],s=[this.ui.width/2,this.ui.height/2],r=sglMulM4V4(e,sglV4C(i[0],i[1],0,1)).slice(0,2),n=s[0]-r[0],o=s[1]-r[1];this.currentSpeed=0,this.currentPoint=r,this._updateMoveStack(r,s,sglV2C(n,o))}else this.renderer.updateData=!0,this.isMoving=!1;return void(this.animating=!1)}var a=this.animationStack.splice(0,1)[0],l=a[0];tx=a[1],ty=a[2];var h=sglMulM4(sglTranslationM4C(tx,ty,0),sglMulM4(sglScalingM4C(l,l,1),sglMulM4(sglTranslationM4C(-tx,-ty,0),this.mat))),d=this.returnModelMatrix(this.translation,h),u=sglMulM4V4(d,sglV4C(this.leftBottom[0],this.leftBottom[1],0,1)).slice(0,2),c=sglMulM4V4(d,sglV4C(this.rightTop[0],this.rightTop[1],0,1)).slice(0,2);u[0]-=this.viewerdx,u[1]-=this.viewerdy,c[0]+=this.viewerdx,c[1]+=this.viewerdy;var m=c[0]-u[0],g=c[1]-u[1],n=0,o=0;if(m>this.ui.width&&g>this.ui.height)c[0]<this.ui.width?n+=this.ui.width-c[0]:u[0]>0&&(n-=u[0]),c[1]<this.ui.height?o+=this.ui.height-c[1]:u[1]>0&&(o-=u[1]);else if(m>this.ui.width)ty=this.ui.height/2-this.translation[1],c[0]<this.ui.width?n+=this.ui.width-c[0]:u[0]>0&&(n-=u[0]);else{if(!(g>this.ui.height))return tx=this.ui.width/2,ty=this.ui.height/2,this.resetViewpoint(),void(0==this.animationStack.lenght&&(clearInterval(this.zoomInterval),this.renderer.updateData=!0));tx=this.ui.width/2-this.translation[0],c[1]<this.ui.height?o+=this.ui.height-c[1]:u[1]>0&&(o-=u[1])}this.mat=sglMulM4(sglTranslationM4C(tx,ty,0),sglMulM4(sglScalingM4C(l,l,1),sglMulM4(sglTranslationM4C(-tx,-ty,0),this.mat))),this.translation[0]+=n,this.translation[1]+=o,this.isRepeating&&this.repeatEvent(this.btnType),_SGL_RegisteredCanvas[this.canvas].requestDraw()},sendMouseDown:function(t){_SGL_RegisteredCanvas[this.canvas].mouseDown(t)},mouseDown:function(t,e,i,s){if(this.animating)return!1;if(0==e){if(this.ui.keysDown[17])return this._setLightDir(i,s),!0;if(0==this.mode){this.endAnimation=!1,this.currentPoint=[i,s],this.animationStack=[];var r=this;return clearInterval(this.zoomInterval),clearInterval(this.moveInterval),this.moveInterval=setInterval(function(){r._moveAnimation()},35),this.renderer.updateData=!1,this.isMoving=!0,!1}return 1==this.mode&&this._setLightDir(i,s),!0}},_moveAnimation:function(){if((this.moveToCenter||this.endAnimation)&&0==this.animationStack.length)return clearInterval(this.moveInterval),this.renderer.updateData=!0,this.isMoving=!1,this.animating=!1,void(this.moveToCenter=!1);if(0==this.animationStack.length)return void(this.currentSpeed=0);var t=this.animationStack.splice(0,1)[0],e=t[0]-this.currentPoint[0],i=t[1]-this.currentPoint[1];this.currentSpeed=t[2],this.translation[0]+=e,this.translation[1]+=i,this.currentPoint[0]=t[0],this.currentPoint[1]=t[1],this.isRepeating&&this.repeatEvent(this.btnType),_SGL_RegisteredCanvas[this.canvas].requestDraw()},mouseUp:function(t,e){return 0==e&&0==this.mode&&(this.endAnimation=!0,this.renderer.updateData=!0,this.isMoving=!1),!1},mouseOut:function(){this.endAnimation=!0,this.isMoving=!1},mouseMove:function(t,e,i){if(this.animating)return!1;if(this.ui.mouseButtonsDown[0]){if(0==this.mode){if(this.ui.keysDown[17])return this._setLightDir(e,i),!0;var s=[e,i],r=s[0]-this.currentPoint[0],n=s[1]-this.currentPoint[1],o=this._adjustTranslation(r,n);return s=[this.currentPoint[0]+o[0],this.currentPoint[1]+o[1]],this._updateMoveStack(this.currentPoint,s,o),!1}return this._setLightDir(e,i),!0}return!1},_updateMoveStack:function(t,e,i){var s=sglLengthV2(i);if(s>.1){this.animationStack.splice(0,this.animationStack.length);var r=sglNormalizedV2(i),n=2*(s/2-this.currentSpeed*this.maxStep)/(this.maxStep*this.maxStep),o=this.currentSpeed,a=[t[0],t[1]],l=0,h=this.maxStep,d=0,u=0;if(n>0){for(var c=0;c<this.maxStep;c++){var m=n/2+o;o+=n,l+=m;var g=r[0]*m,p=r[1]*m;a[0]+=g,a[1]+=p,this.animationStack.push([a[0],a[1],o,n])}h=3*s/(2*o),u=4*o*o*o/(9*s*s),d=-4*o*o/(3*s)}else h=6*s/(2*o),u=o*o*o/(9*s*s),d=-2*o*o/(3*s);for(var c=0;h>c;c++){var m=u*c+u/3+d/2+o;o+=u*(2*c+1)+d;var g=r[0]*m,p=r[1]*m;a[0]+=g,a[1]+=p,this.animationStack.push([a[0],a[1],o,u])}this.animationStack.push([e[0],e[1],0,0])}},_adjustTranslation:function(t,e){var i=sglV4C(this.translation[0]+t,this.translation[1]+e,0,1),s=this.returnModelMatrix(i,this.mat),r=sglMulM4V4(s,sglV4C(this.leftBottom[0],this.leftBottom[1],0,1)).slice(0,2),n=sglMulM4V4(s,sglV4C(this.rightTop[0],this.rightTop[1],0,1)).slice(0,2);r[0]-=this.viewerdx,r[1]-=this.viewerdy,n[0]+=this.viewerdx,n[1]+=this.viewerdy;var o=n[0]-r[0],a=n[1]-r[1],l=t,h=e;return o>this.ui.width&&a>this.ui.height?(n[0]<this.ui.width?l+=this.ui.width-n[0]:r[0]>0&&(l-=r[0]),n[1]<this.ui.height?h+=this.ui.height-n[1]:r[1]>0&&(h-=r[1])):o>this.ui.width?(n[0]<this.ui.width?l+=this.ui.width-n[0]:r[0]>0&&(l-=r[0]),h=0):a>this.ui.height?(n[1]<this.ui.height?h+=this.ui.height-n[1]:r[1]>0&&(h-=r[1]),l=0):(l=0,h=0),sglV2C(l,h)},startPinch:function(t,e,i,s){return this.endAnimation=!1,this.currentPoint=[i,s],this.animationStack=[],clearInterval(this.zoomInterval),clearInterval(this.moveInterval),!1},pinch:function(t,e,i,s){var r=e,n=this.mat[0]*e;n>this.maxScale&&(r=this.maxScale/this.mat[0]),1>n&&(r=1/this.mat[0]);var o=i,a=s,l=i,h=s,e=this._adjustTranslation(o-this.currentPoint[0],a-this.currentPoint[1]),d=e[0],u=e[1];this.translation[0]+=d,this.translation[1]+=u,this.currentPoint[0]=o,this.currentPoint[1]=a;var c=[this.translation[0],this.translation[1]],m=sglMulM4(sglTranslationM4C(l-c[0],h-c[1],0),sglMulM4(sglScalingM4C(r,r,1),sglMulM4(sglTranslationM4C(c[0]-l,c[1]-h,0),this.mat))),g=this.returnModelMatrix(this.translation,m),p=sglMulM4V4(g,sglV4C(this.leftBottom[0],this.leftBottom[1],0,1)).slice(0,2),f=sglMulM4V4(g,sglV4C(this.rightTop[0],this.rightTop[1],0,1)).slice(0,2);p[0]-=this.viewerdx,p[1]-=this.viewerdy,f[0]+=this.viewerdx,f[1]+=this.viewerdy;var v=f[0]-p[0],_=f[1]-p[1];return d=0,u=0,v>this.ui.width&&_>this.ui.height?(f[0]<this.ui.width?d+=this.ui.width-f[0]:p[0]>0&&(d-=p[0]),f[1]<this.ui.height?u+=this.ui.height-f[1]:p[1]>0&&(u-=p[1])):v>this.ui.width?(h=this.ui.height/2-this.translation[1],f[0]<this.ui.width?d+=this.ui.width-f[0]:p[0]>0&&(d-=p[0])):_>this.ui.height?(l=this.ui.width/2-this.translation[0],f[1]<this.ui.height?u+=this.ui.height-f[1]:p[1]>0&&(u-=p[1])):(l=this.ui.width/2,h=this.ui.height/2),this.mat=sglMulM4(sglTranslationM4C(l-c[0],h-c[1],0),sglMulM4(sglScalingM4C(r,r,1),sglMulM4(sglTranslationM4C(c[0]-l,c[1]-h,0),this.mat))),this.translation[0]+=d,this.translation[1]+=u,this.currentPoint=[i,s],!0},update:function(){},returnModelMatrix:function(t,e){var i=sglMulM4(sglTranslationM4C(t[0],t[1],1),e);i=sglMulM4(this.flipMatrix,i),this.xform.model.load(i);var s=sglTranslationM4C(this.ui.width/2,this.ui.height/2,0);return this.xform.model.multiply(s),this.xform.model.scale(this.scale,this.scale,1),this.xform.model.multiply(this.renderer.normalizedTreeTransform),this.xform.model.top},computeModelMatrix:function(){var t=sglMulM4(sglTranslationM4C(this.translation[0],this.translation[1],1),this.mat);t=sglMulM4(this.flipMatrix,t),this.xform.model.load(t);var e=sglTranslationM4C(this.ui.width/2,this.ui.height/2,0);this.xform.model.multiply(e),this.xform.model.scale(this.scale,this.scale,1),this.xform.model.multiply(this.renderer.normalizedTreeTransform)},resize:function(){this.xform=new SglTransformStack,this.translation=[0,0],this.mat=sglIdentityM4(),this.rendering=!0,this.leftBottom=[(this.renderer._tree.scale[0]-this.renderer.imgWidth)/2,(this.renderer._tree.scale[1]-this.renderer.imgHeight)/2],this.rightTop=[this.leftBottom[0]+this.renderer.imgWidth,this.leftBottom[1]+this.renderer.imgHeight],this.scale=0;var t=this.ui.width;this.offsetHeight=0;var e=this.ui.height+this.offsetHeight;this.scale=Math.min(this.renderer._tree.scale[0]/this.renderer.imgWidth*t,this.renderer._tree.scale[1]/this.renderer.imgHeight*e),this.maxScale=3*Math.max(this.renderer.imgWidth/t,this.renderer.imgHeight/e),this.viewerdx=100,this.viewerdy=100},draw:function(t){var e=t.getError();if(e==t.CONTEXT_LOST_WEBGL&&console.log("WebGL Context lost"),t.clearColor(0,0,0,1),t.clear(t.COLOR_BUFFER_BIT|t.DEPTH_BUFFER_BIT|t.STENCIL_BUFFER_BIT),1==this.rendering){var i=this.ui.width,s=this.ui.height;t.viewport(0,0,i,s),this.xform.projection.loadIdentity(),this.xform.projection.ortho(0,i,0,s,-4096,4096),this.xform.view.loadIdentity(),this.xform.view.lookAt(0,0,2,0,0,0,0,1,0),this.computeModelMatrix();var r=this.xform.model.top;this.onDrawCallback&&this.onDrawCallback(r),this.renderer.render(this.xform.projectionMatrix,this.xform.modelViewMatrix,[0,0,i,s])}}},MultiResTree.prototype={_load:function(t,e,i){this.ready=!0;var s=sglGetLines(t),r=s.length,n=null,o=0;if(!(o>=r||(n=s[o++].split(" "),n.length<2))){var a=parseInt(n[0]);if(!(0>=a)){var l=parseInt(n[1]);if(!(0>l||l>=a||o>=r||(n=s[o++].split(" "),n.length<1))){var h=parseInt(n[0]);if(!(0>=h||o>=r||(n=s[o++].split(" "),n.length<3))){var d=[1,1,1];if(d[0]=parseFloat(n[0]),d[1]=parseFloat(n[1]),d[2]=parseFloat(n[2]),!(o>=r||(n=s[o++].split(" "),n.length<3))){var u=[0,0,0];u[0]=parseFloat(n[0]),u[1]=parseFloat(n[1]),u[2]=parseFloat(n[2]);var c=new Array(a);if(r>o)for(var m=0;a>m;++m){var g=new MultiResNode;if(o>=r)return;if(n=s[o++].split(" "),n.length<14)return;if(g.id=parseInt(n[0]),g.id<=0)return;if(g.parentIndex=parseInt(n[1]),g.parentIndex<-1||g.parentIndex>=a)return;for(var p=0;4>p;++p)if(g.childrenIndices[p]=parseInt(n[p+2]),g.childrenIndices[p]<-1||g.childrenIndices[p]>=a)return;g.projectedSize=parseFloat(n[6]),g.zScale=parseFloat(n[7]),g.box.min[0]=parseFloat(n[8]),g.box.min[1]=parseFloat(n[9]),g.box.min[2]=parseFloat(n[10]),g.box.max[0]=parseFloat(n[11]),g.box.max[1]=parseFloat(n[12]),g.box.max[2]=parseFloat(n[13]),g.isLeaf=!0;for(var f=0;4>f;++f)if(g.childrenIndices[f]>=0){g.isLeaf=!1;break}c[m]=g}else{for(var v=0,_=d[0],b=1;_>h;)b++,_/=2;for(var x=(d[0]-e)/2/d[0],M=(d[1]-i)/2/d[1],w=new SglBox3([x,M,0],[x+e/d[0],M+i/d[1],1]),y=w.size,R=w.center,o=0;b>o;o++)for(var T=Math.pow(4,o),f=0;T>f;f++){var g=new MultiResNode;g.id=v+1,g.parentIndex=v>0?Math.ceil(v/4)-1:-1,b-1>o&&(g.isLeaf=!1);for(var p=0;4>p;++p)g.childrenIndices[p]=o==b-1?-1:4*v+1+(p+2)%4;if(g.projectedSize=h,v>0){var I=v%4,S=c[g.parentIndex],F=S.box.min[0]+(S.box.max[0]-S.box.min[0])/2,C=S.box.min[1]+(S.box.max[1]-S.box.min[1])/2;1==I?g.box=new SglBox3([S.box.min[0],C,0],[F,S.box.max[1],1]):2==I?g.box=new SglBox3([F,C,0],S.box.max):3==I?g.box=new SglBox3(S.box.min,[F,C,1]):0==I&&(g.box=new SglBox3([F,S.box.min[1],0],[S.box.max[0],C,1]));var L=g.box.center,k=g.box.size,P=sglSelfMulV3S(sglAddV3(y,k),.5),z=sglSubV3(R,L);g.zScale=Math.abs(z[0])<=P[0]&&Math.abs(z[1])<=P[1]&&Math.abs(z[2])<=P[2]?1:0}else g.box=new SglBox3([0,0,0],[1,1,1]),g.zScale=1;c[v]=g,v++}}this.nodesCount=a,this.rootIndex=l,this.tileSize=h,this.scale=d,this.offset=u,this.nodes=c}}}}}},destroy:function(t){var e=null;for(var i in this.nodes)e=this.nodes[i],e.req&&(e.req.onLoad=null,e.req=null),e.data&&(t(e.data),e.data=null);this.ready=!0,this.nodesCount=0,this.rootIndex=-1,this.nodes=null,this.url=null,this.tileSize=0,this.scale=[1,1,1]},load:function(t,e,i){return t?void this._load(t,e,i):!1},get isEmpty(){return this.nodesCount<=0},get root(){var t=this.rootIndex;return 0>t?null:this.nodes[t]},parent:function(t){var e=t.parentIndex;return 0>e?null:this.nodes[e]},child:function(t,e){var i=t.childrenIndices[e];return 0>i?null:this.nodes[i]}},MultiResRenderer.prototype={computeLightingFunction:function(t){switch(this.enumType[this.type]){case 1:var e=Math.atan2(t[1],t[0]);0>e&&(e=2*Math.PI+e);var i=Math.min(Math.acos(t[2]),Math.PI/2-.15),s=Math.cos(e),r=Math.cos(i),n=r*r,o=new Array(9);return o[0]=1/Math.sqrt(2*Math.PI),o[1]=Math.sqrt(6/Math.PI)*s*Math.sqrt(r-n),o[2]=Math.sqrt(3/(2*Math.PI))*(-1+2*r),o[3]=Math.sqrt(6/Math.PI)*Math.sqrt(r-n)*Math.sin(e),o[4]=Math.sqrt(30/Math.PI)*Math.cos(2*e)*(-r+n),o[5]=Math.sqrt(30/Math.PI)*s*(-1+2*r)*Math.sqrt(r-n),o[6]=Math.sqrt(5/(2*Math.PI))*(1-6*r+6*n),o[7]=Math.sqrt(30/Math.PI)*(-1+2*r)*Math.sqrt(r-n)*Math.sin(e),o[8]=Math.sqrt(30/Math.PI)*(-r+n)*Math.sin(2*e),o;case 2:case 3:var o=new Array(6);return o[0]=t[0]*t[0],o[1]=t[1]*t[1],o[2]=t[0]*t[1],o[3]=t[0],o[4]=t[1],o[5]=1,o}return[]},loadImage:function(t){var e=new XMLHttpRequest;e.open("GET",t+"/info.xml",!1),e.send();var i=e.responseXML;this.format="jpg";var s=parseInt(i.getElementsByTagName("MultiRes")[0].getAttribute("format"));isNaN(s)||1==s&&(this.format="png");var r=i.getElementsByTagName("Content")[0];if(this.type=r.getAttribute("type"),!(this.type in this.enumType))return!1;var n=null;switch(this.enumType[this.type]){case 1:case 2:case 3:var o=i.getElementsByTagName("Size")[0],a=i.getElementsByTagName("Scale")[0],l=i.getElementsByTagName("Bias")[0];if(n=i.getElementsByTagName("Tree")[0],this.imgWidth=parseInt(o.getAttribute("width")),this.imgHeight=parseInt(o.getAttribute("height")),this.ordlen=parseInt(o.getAttribute("coefficients")),this.numLayers=this.ordlen,2==this.enumType[this.type]&&(this.numLayers=3),tokens=a.childNodes[0].nodeValue.split(" "),tokens.length<this.ordlen)return;this.gmax=[];for(var h=0;h<this.ordlen;h++)this.gmax[h]=parseFloat(tokens[h]);if(tokens=l.childNodes[0].nodeValue.split(" "),tokens.length<this.ordlen)return;this.gmin=[];for(var h=0;h<this.ordlen;h++)this.gmin[h]=parseFloat(tokens[h]);break;case 4:var o=i.getElementsByTagName("Size")[0];n=i.getElementsByTagName("Tree")[0],this.imgWidth=parseInt(o.getAttribute("width")),this.imgHeight=parseInt(o.getAttribute("height")),this.ordlen=parseInt(o.getAttribute("coefficients")),this.numLayers=this.ordlen;break;default:return}switch(this._tree&&this._tree.destroy(this._destroyData),this._tree.load(n.textContent,this.imgWidth,this.imgHeight),this._url=t,this._timestamp=0,this._frustum=new SglFrustum,this._maxError=1,this._cache=[],this._toRequest=[],this._toRenderFullRes=[],this._toRenderHalfRes=[],this._readyItems=[],this.renderData=!0,this.renderBoxes=!1,this.lightPos=[0,0,1],this.lweights=[],this.lweights=this.computeLightingFunction(this.lightPos),null!=this._program&&this._program.destroy(),this.enumType[this.type]){case 1:var d=sglLoadFile("spidergl/multi.v.glsl"),u=sglLoadFile("spidergl/hsh.f.glsl"),c=new SglProgram(this.gl,[d],[u]);log(c.log),this._program=c;break;case 2:var d=sglLoadFile("spidergl/multi.v.glsl"),u=sglLoadFile("spidergl/lrgbptm.f.glsl"),c=new SglProgram(this.gl,[d],[u]);log(c.log),this._program=c;break;case 3:var d=sglLoadFile("spidergl/multi.v.glsl"),u=sglLoadFile("spidergl/rgbptm.f.glsl"),c=new SglProgram(this.gl,[d],[u]);log(c.log),this._program=c;break;case 4:var d=sglLoadFile("spidergl/multi.v.glsl"),u=sglLoadFile("spidergl/image.f.glsl"),c=new SglProgram(this.gl,[d],[u]);log(c.log),this._program=c;break;default:this._program=new SglProgram}this._renderer=new SglMeshGLRenderer(this._program),this._treeTransform=sglIdentityM4(),this._normalizedTreeTransform=sglIdentityM4(),this.leftTex=(this._tree.scale[0]-this.imgWidth)/2,this.rightTex=this.leftTex+this.imgWidth,this.bottomTex=(this._tree.scale[1]-this.imgHeight)/2,this.topTex=this.bottomTex+this.imgHeight,this.leftTex/=this._tree.scale[0],this.rightTex/=this._tree.scale[0],this.bottomTex/=this._tree.scale[1],this.topTex/=this._tree.scale[1],this._tree.ready&&this._setupTree()},_createLg:function(){var t=document.createElement("canvas");t.height=50,t.width=80;var e=t.getContext("2d");e.save(),e.beginPath(),e.moveTo(0,0),e.lineTo(80,0),e.lineTo(80,50),e.lineTo(0,50),e.closePath(),e.clip(),e.strokeStyle="rgba(0,0,0,0)",e.lineCap="butt",e.lineJoin="miter",e.miterLimit=4,e.save(),e.restore(),e.save(),e.restore(),e.save(),e.transform(.21814175,0,0,.21573678,-3.3721339,-3.3665838),e.save(),e.translate(14.071762,20),e.save(),g=e.createRadialGradient(239.50893,204.66128888494003,0,239.50893,204.66128888494003,31.820419),g.addColorStop(0,"rgba(255, 255, 255, 1)"),g.addColorStop(1,"rgba(151, 151, 151, 1)"),e.fillStyle=g,e.strokeStyle="#000000",e.lineWidth=2.4923694133758545,e.lineCap="round",e.lineJoin="round",e.miterLimit=4,e.transform(2.1234583,0,0,1.6108995,-256.37574,-264.34719),e.beginPath(),e.moveTo(271.42857,233.79076),e.translate(240,233.80553976769053),e.rotate(0),e.scale(.7586207296076113,1),e.arc(0,0,41.42857,-.00035675303306008355,3.1419494066230014,0),e.scale(1.318181748760332,1),e.rotate(0),e.translate(-240,-233.80553976769053),e.translate(240,233.77598023230948),e.rotate(0),e.scale(.7586207296076113,1),e.arc(0,0,41.42857,3.141235900556733,6.2835420602127945,0),e.scale(1.318181748760332,1),e.rotate(0),e.translate(-240,-233.77598023230948),e.closePath(),e.fill(),e.stroke(),e.restore(),e.save(),e.fillStyle="#ececec",e.strokeStyle="#000000",e.lineWidth=4.609655857086182,e.lineCap="butt",e.lineJoin="round",e.miterLimit=4,e.beginPath(),e.moveTo(49.495605,44.507569),e.lineTo(129.49561,79.507569),e.lineTo(209.49561,44.507569),e.lineTo(49.495605,44.507569),e.closePath(),e.fill(),e.stroke(),e.restore(),e.save(),e.fillStyle="#999999",e.strokeStyle="#000000",e.lineWidth=4.609655857086182,e.lineCap="butt",e.lineJoin="round",e.miterLimit=4,e.beginPath(),e.moveTo(129.49561,174.50757),e.lineTo(129.49561,79.507572),e.lineTo(209.49561,44.507572),e.lineTo(129.49561,174.50757),e.closePath(),e.fill(),e.stroke(),e.restore(),e.save(),e.fillStyle="#b3b3b3",e.strokeStyle="#000000",e.lineWidth=4.609655857086182,e.lineCap="butt",e.lineJoin="round",e.miterLimit=4,e.beginPath(),e.moveTo(129.49561,174.50757),e.lineTo(129.49561,79.507569),e.lineTo(49.495605,44.507569),e.lineTo(129.49561,174.50757),e.closePath(),e.fill(),e.stroke(),e.restore(),e.save(),g=e.createLinearGradient(236.58487,196.44904,257.4877,320.66739),g.addColorStop(0,"rgba(255, 255, 255, 1)"),g.addColorStop(1,"rgba(151, 151, 151, 1)"),e.fillStyle=g,e.strokeStyle="#000000",e.lineWidth=3.3579113483428955,e.lineCap="round",e.lineJoin="round",e.miterLimit=4,e.transform(1.4965962,0,0,1.2591977,-86.218969,-182.0266),e.beginPath(),e.moveTo(271.42857,233.79076),e.translate(240,233.80553976769053),e.rotate(0),e.scale(.7586207296076113,1),e.arc(0,0,41.42857,-.00035675303306008355,3.1419494066230014,0),e.scale(1.318181748760332,1),e.rotate(0),e.translate(-240,-233.80553976769053),e.translate(240,233.77598023230948),e.rotate(0),e.scale(.7586207296076113,1),e.arc(0,0,41.42857,3.141235900556733,6.2835420602127945,0),e.scale(1.318181748760332,1),e.rotate(0),e.translate(-240,-233.77598023230948),e.closePath(),e.fill(),e.stroke(),e.restore(),e.restore(),e.restore(),e.restore();
var i=new Image,s=t.toDataURL("image/png");i.src=s;var r=this;i.onload=function(){var t={generateMipmap:!1,minFilter:r.gl.NEAREST,magFilter:r.gl.NEAREST};r.lgtex=new SglTexture2D(r.gl,i,t)};this.gl.getError()},_createData:function(t){for(var e={minFilter:this.gl.LINEAR,magFilter:this.gl.LINEAR,generateMipmap:!1},i=new Array(t.length),s=0;s<t.length;++s)i[s]=new SglTexture2D(this.gl,t[s],e);var r={textures:i};return r},_destroyData:function(t){if(t){for(var e=0;e<t.textures.length;++e)t.textures[e].destroy();t.textures=null}},_requestNode:function(t){if(!t.req){for(var e=this,i=this._url+"/"+t.id,s=new Array,r=1;r<=this.numLayers;r++)s.push(new SglImageRequest(i+"_"+r+"."+this.format));var n=new SglRequestWatcher(s,function(){e._currentOngoingRequests--,e._readyItems.push(t)});t.req=n,n.send()}},_collectNodesRec:function(t,e){var i={needed:!1,usable:t.data?!0:!1};if(0==t.zScale)return i;if(!e){var s=this._frustum.boxVisibility(t.box.min,t.box.max);if(s==SGL_OUTSIDE_FRUSTUM)return i;e=s==SGL_INSIDE_FRUSTUM}i.needed=!0;var r=this._frustum.projectedSegmentSize(t.box.center,t.box.size[0]),n=r/t.projectedSize;if(t.priority.timestamp=this._timestamp,t.priority.error=n,!i.usable)return t.req||this._toRequest.push(t),i;if(n<this._maxError||t.isLeaf)return this._toRenderFullRes.push(t),i;for(var o=null,a=0,l=0,h=null,d=[],u=0;4>u;++u)o=this._tree.child(t,u),o&&(h=this._collectNodesRec(o,e),h.usable&&l++,h.needed&&(a++,h.usable||d.push(u)));return a>0&&(0>=l?this._toRenderFullRes.push(t):d.length>0&&this._toRenderHalfRes.push({n:t,children:d})),i},_collectNodes:function(){this._toRequest=[],this._toRenderFullRes=[],this._toRenderHalfRes=[];var t=this._tree.root;t&&this._collectNodesRec(t,!1)},_renderNodeFullRes:function(t){for(var e={u_world_box_min:t.box.min,u_world_box_max:t.box.max},i=[],s=0;s<this.numLayers;s++)i["coeff"+s]=t.data.textures[s];this._renderer.setUniforms(e),this._renderer.setSamplers(i),this._renderer.render()},_renderNodesFullRes:function(t){var e=null,i=null;e=this._tileFullMesh,i="tristrip";var s={u_model_view_projection_matrix:t,u_scale_bias:[1,1,0,0],u_texcoord_scale_bias:[this._tree.tileSize/(this._tree.tileSize+2),1/(this._tree.tileSize+2)],ordlen:this.ordlen,leftTex:this.leftTex,rightTex:this.rightTex,bottomTex:this.bottomTex,topTex:this.topTex};if(4!=this.enumType[this.type])for(var r=0;r<this.ordlen;r++)s["gmax"+r]=this.gmax[r],s["gmin"+r]=this.gmin[r],s["lweight"+r]=this.lweights[r];this._renderer.begin(),this._renderer.setUniforms(s),this._renderer.beginMesh(e),this._renderer.beginPrimitives(i);var n=null;for(var r in this._toRenderFullRes)n=this._toRenderFullRes[r],this._renderNodeFullRes(n);this._renderer.endPrimitives(),this._renderer.endMesh(),this._renderer.end()},_renderNodeHalfRes:function(t,e){for(var i={u_world_box_min:null,u_world_box_max:null,u_scale_bias:null},s=[],r=0;r<this.numLayers;r++)s["coeff"+r]=t.data.textures[r];this._renderer.setSamplers(s);var n=[[.5,.5,0,0],[.5,.5,.5,0],[.5,.5,0,.5],[.5,.5,.5,.5]],o=null;for(var r in e)o=this._tree.child(t,e[r]),i.u_world_box_min=o.box.min,i.u_world_box_max=o.box.max,i.u_scale_bias=n[e[r]],this._renderer.setUniforms(i),this._renderer.render()},_renderNodesHalfRes:function(t){var e=null,i=null;e=this._tileHalfMesh,i="tristrip";var s={u_model_view_projection_matrix:t,u_texcoord_scale_bias:[this._tree.tileSize/(this._tree.tileSize+2),1/(this._tree.tileSize+2)],ordlen:this.ordlen,leftTex:this.leftTex,rightTex:this.rightTex,bottomTex:this.bottomTex,topTex:this.topTex};if(4!=this.enumType[this.type])for(var r=0;r<this.ordlen;r++)s["gmax"+r]=this.gmax[r],s["gmin"+r]=this.gmin[r],s["lweight"+r]=this.lweights[r];this._renderer.begin(),this._renderer.setUniforms(s),this._renderer.beginMesh(e),this._renderer.beginPrimitives(i);var n=null;for(var r in this._toRenderHalfRes)n=this._toRenderHalfRes[r],this._renderNodeHalfRes(n.n,n.children);this._renderer.endPrimitives(),this._renderer.endMesh(),this._renderer.end()},_renderNodes:function(t){this._renderNodesFullRes(t),this._renderNodesHalfRes(t)},_renderNodeFullResBox:function(t){var e=t.box.size,i={u_world_box_min:sglAddV3S(t.box.min,.05*e[0]),u_world_box_max:sglSubV3S(t.box.max,.05*e[0]),u_color:t.isLeaf?[1,0,1]:[0,1,0]};this._boxRenderer.setUniforms(i),this._boxRenderer.render()},_renderNodesFullResBoxes:function(t){var e={u_model_view_projection_matrix:t};this._boxRenderer.begin(),this._boxRenderer.setUniforms(e),this._boxRenderer.beginMesh(this._boxMesh),this._boxRenderer.beginPrimitives("edges");var i=null;for(var s in this._toRenderFullRes)i=this._toRenderFullRes[s],this._renderNodeFullResBox(i);this._boxRenderer.endPrimitives(),this._boxRenderer.endMesh(),this._boxRenderer.end()},_renderNodeHalfResBox:function(t,e){var i={u_world_box_min:null,u_world_box_max:null,u_color:null},s=null;for(var r in e)s=this._tree.child(t,e[r]),sz=s.box.size,i.u_world_box_min=sglAddV3S(s.box.min,.05*sz[0]),i.u_world_box_max=sglSubV3S(s.box.max,.05*sz[0]),i.u_color=s.isLeaf?[1,1,0]:[1,1,1],this._boxRenderer.setUniforms(i),this._boxRenderer.render()},_renderNodesHalfResBoxes:function(t){var e={u_model_view_projection_matrix:t};this._boxRenderer.begin(),this._boxRenderer.setUniforms(e),this._boxRenderer.beginMesh(this._boxMesh),this._boxRenderer.beginPrimitives("edges");var i=null;for(var s in this._toRenderHalfRes)i=this._toRenderHalfRes[s],this._renderNodeHalfResBox(i.n,i.children);this._boxRenderer.endPrimitives(),this._boxRenderer.endMesh(),this._boxRenderer.end()},_renderNodesBoxes:function(t){this.gl.lineWidth(2),this.gl.depthFunc(this.gl.LEQUAL),this._renderNodesFullResBoxes(t),this._renderNodesHalfResBoxes(t),this.gl.depthFunc(this.gl.LESS),this.gl.lineWidth(1)},_doRender:function(t,e,i){var s=sglMulM4(e,this._treeTransform);this._timestamp++,this._frustum.setup(t,s,i),this._collectNodes();var r=sglMulM4(t,s);if(this.renderData&&this._renderNodes(r),this.renderBoxes&&this._renderNodesBoxes(r),this.lg&&null!=this.lgtex){this.gl.enable(this.gl.BLEND),this.gl.blendFunc(this.gl.SRC_ALPHA,this.gl.ONE_MINUS_SRC_ALPHA);var n=sglMulM4(t,sglScalingM4C(1,1,1)),o={u_mvp:n},a={s_texture:this.lgtex};sglRenderMeshGLPrimitives(this.lgMesh,"tristrip",this.texProg,null,o,a),this.gl.disable(this.gl.BLEND)}},_updateCache:function(){var t=1,e=this._readyItems.slice(0,t);this._readyItems.splice(0,t);var i=this._cache.concat(e);i.sort(_MultiResCompareNodes);var s=i.length,r=this._maxCacheSize<s?this._maxCacheSize:s;this._cache=i.splice(0,r);for(var n=i,o=null,a=null,l=[],h=0;r>h;++h)if(o=this._cache[h],a=o.req,o.req=null,a)if(a.succeeded){for(var d=new Array(a.requests.length),h=0;h<d.length;++h)d[h]=a.requests[h].image;o.data&&this._destroyData(o.data),o.data=this._createData(d)}else l.push(h);var u=l.length,c=0;r=n.length;for(var h=0;r>h;++h)o=n[h],a=o.req,o.req=null,a||(u>c?(this._cache[l[c]]=o,c++):(this._destroyData(o.data),o.data=null));c>0&&this._cache.sort(_MultiResCompareNodes)},_requestNodes:function(){var t=this._cache.length,e=t>0?this._cache[t-1]:null;this._toRequest.sort(_MultiResCompareNodes);for(var i=this._maxOngoingRequests-this._currentOngoingRequests,s=0,r=this._toRequest.length,n=null,o=!1,a=0;r>a&&i>s;++a)n=this._toRequest[a],n.req||(o=!0,null!=e&&t>=this._maxCacheSize&&(o=_MultiResCompareNodes(n,e)<0),o&&(this._requestNode(n),s++))},_calculateNormalizedTreeTransform:function(){var t=this._tree.root;if(!t)return sglIdentityM4();var e=new SglBox3;e.min=sglAddV3(sglMulV3(t.box.min,this._tree.scale),this._tree.offset),e.max=sglAddV3(sglMulV3(t.box.max,this._tree.scale),this._tree.offset),this._treeTransform=sglMulM4(sglTranslationM4V(this._tree.offset),sglScalingM4V(this._tree.scale));var i=e.center,s=e.size,r=s[0];r<s[1]&&(r=s[1]),r<s[2]&&(r=s[2]);var n=r>0?1/r:1,o=sglScalingM4C(n,n,n),a=sglTranslationM4C(-i[0],-i[1],-i[2]),l=sglMulM4(o,a);this._normalizedTreeTransform=l},_setupTree:function(){var t=this._tree.root;if(t){var e=this.gl,i=(this._tree.tileSize+2)*(this._tree.tileSize+2)*this.ordlen*3;this._maxCacheSize=sglFloor(this._cacheSizeInBytes/i),this._maxCacheSize<=0&&(this._maxCacheSize=1);var s=new Float32Array([-.5,.5,-.5,-.5,.5,.5,.5,-.5]),r=new SglMeshGL(e);r.addVertexAttribute("position",2,s),r.addArrayPrimitives("tristrip",e.TRIANGLE_STRIP,0,4),this._tileFullMesh=r,this._tileHalfMesh=r,this._calculateNormalizedTreeTransform()}},render:function(t,e,i){this._tree.root&&(this._doRender(t,e,i),this.updateData&&(this._updateCache(),this._requestNodes()))},get normalizedTreeTransform(){return this._normalizedTreeTransform}};